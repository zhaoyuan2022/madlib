DROP TABLE IF EXISTS abalone;

CREATE TABLE abalone (
    id integer,
    sex text,
    length double precision,
    diameter double precision,
    height double precision,
    whole double precision,
    shucked double precision,
    viscera double precision,
    shell double precision,
    rings integer
);

INSERT INTO abalone VALUES
(3151, 'F', 0.655000000000000027, 0.505000000000000004, 0.165000000000000008, 1.36699999999999999, 0.583500000000000019, 0.351499999999999979, 0.396000000000000019, 10),
(2026, 'F', 0.550000000000000044, 0.469999999999999973, 0.149999999999999994, 0.920499999999999985, 0.381000000000000005, 0.243499999999999994, 0.267500000000000016, 10),
(3751, 'I', 0.434999999999999998, 0.375, 0.110000000000000001, 0.41549999999999998, 0.170000000000000012, 0.0759999999999999981, 0.14499999999999999, 8),
(720, 'I', 0.149999999999999994, 0.100000000000000006, 0.0250000000000000014, 0.0149999999999999994, 0.00449999999999999966, 0.00400000000000000008, 0.0050000000000000001, 2),
(1635, 'F', 0.574999999999999956, 0.469999999999999973, 0.154999999999999999, 1.1160000000000001, 0.509000000000000008, 0.237999999999999989, 0.340000000000000024, 10),
(2648, 'I', 0.5, 0.390000000000000013, 0.125, 0.582999999999999963, 0.293999999999999984, 0.132000000000000006, 0.160500000000000004, 8),
(1796, 'F', 0.57999999999999996, 0.429999999999999993, 0.170000000000000012, 1.47999999999999998, 0.65349999999999997, 0.32400000000000001, 0.41549999999999998, 10),
(209, 'F', 0.525000000000000022, 0.41499999999999998, 0.170000000000000012, 0.832500000000000018, 0.275500000000000023, 0.168500000000000011, 0.309999999999999998, 13),
(1451, 'I', 0.455000000000000016, 0.33500000000000002, 0.135000000000000009, 0.501000000000000001, 0.274000000000000021, 0.0995000000000000051, 0.106499999999999997, 7),
(1108, 'I', 0.510000000000000009, 0.380000000000000004, 0.115000000000000005, 0.515499999999999958, 0.214999999999999997, 0.113500000000000004, 0.166000000000000009, 8),
(3675, 'F', 0.594999999999999973, 0.450000000000000011, 0.165000000000000008, 1.08099999999999996, 0.489999999999999991, 0.252500000000000002, 0.279000000000000026, 12),
(2108, 'F', 0.675000000000000044, 0.550000000000000044, 0.179999999999999993, 1.68849999999999989, 0.562000000000000055, 0.370499999999999996, 0.599999999999999978, 15),
(3312, 'F', 0.479999999999999982, 0.380000000000000004, 0.135000000000000009, 0.507000000000000006, 0.191500000000000004, 0.13650000000000001, 0.154999999999999999, 12),
(882, 'M', 0.655000000000000027, 0.520000000000000018, 0.165000000000000008, 1.40949999999999998, 0.585999999999999965, 0.290999999999999981, 0.405000000000000027, 9),
(3402, 'M', 0.479999999999999982, 0.395000000000000018, 0.149999999999999994, 0.681499999999999995, 0.214499999999999996, 0.140500000000000014, 0.2495, 18),
(829, 'I', 0.409999999999999976, 0.325000000000000011, 0.100000000000000006, 0.394000000000000017, 0.20799999999999999, 0.0655000000000000027, 0.105999999999999997, 6),
(1305, 'M', 0.535000000000000031, 0.434999999999999998, 0.149999999999999994, 0.716999999999999971, 0.347499999999999976, 0.14449999999999999, 0.194000000000000006, 9),
(3613, 'M', 0.599999999999999978, 0.46000000000000002, 0.179999999999999993, 1.1399999999999999, 0.422999999999999987, 0.257500000000000007, 0.364999999999999991, 10),
(1068, 'I', 0.340000000000000024, 0.265000000000000013, 0.0800000000000000017, 0.201500000000000012, 0.0899999999999999967, 0.0475000000000000006, 0.0550000000000000003, 5),
(2446, 'M', 0.5, 0.380000000000000004, 0.135000000000000009, 0.583500000000000019, 0.22950000000000001, 0.126500000000000001, 0.179999999999999993, 12),
(1393, 'M', 0.635000000000000009, 0.474999999999999978, 0.170000000000000012, 1.19350000000000001, 0.520499999999999963, 0.269500000000000017, 0.366499999999999992, 10),
(359, 'M', 0.744999999999999996, 0.584999999999999964, 0.214999999999999997, 2.49900000000000011, 0.92649999999999999, 0.471999999999999975, 0.699999999999999956, 17),
(549, 'F', 0.564999999999999947, 0.450000000000000011, 0.160000000000000003, 0.79500000000000004, 0.360499999999999987, 0.155499999999999999, 0.23000000000000001, 12),
(1154, 'F', 0.599999999999999978, 0.474999999999999978, 0.160000000000000003, 1.02649999999999997, 0.484999999999999987, 0.2495, 0.256500000000000006, 9),
(1790, 'F', 0.54500000000000004, 0.385000000000000009, 0.149999999999999994, 1.11850000000000005, 0.542499999999999982, 0.244499999999999995, 0.284499999999999975, 9),
(3703, 'F', 0.665000000000000036, 0.540000000000000036, 0.195000000000000007, 1.76400000000000001, 0.850500000000000034, 0.361499999999999988, 0.469999999999999973, 11),
(1962, 'F', 0.655000000000000027, 0.515000000000000013, 0.179999999999999993, 1.41199999999999992, 0.619500000000000051, 0.248499999999999999, 0.496999999999999997, 11),
(1665, 'I', 0.604999999999999982, 0.469999999999999973, 0.14499999999999999, 0.802499999999999991, 0.379000000000000004, 0.226500000000000007, 0.220000000000000001, 9),
(635, 'M', 0.359999999999999987, 0.294999999999999984, 0.100000000000000006, 0.210499999999999993, 0.0660000000000000031, 0.0524999999999999981, 0.0749999999999999972, 9),
(3901, 'M', 0.445000000000000007, 0.344999999999999973, 0.140000000000000013, 0.475999999999999979, 0.205499999999999988, 0.101500000000000007, 0.108499999999999999, 15),
(2734, 'I', 0.41499999999999998, 0.33500000000000002, 0.100000000000000006, 0.357999999999999985, 0.169000000000000011, 0.067000000000000004, 0.104999999999999996, 7),
(3856, 'M', 0.409999999999999976, 0.33500000000000002, 0.115000000000000005, 0.440500000000000003, 0.190000000000000002, 0.0850000000000000061, 0.135000000000000009, 8),
(827, 'I', 0.395000000000000018, 0.28999999999999998, 0.0950000000000000011, 0.303999999999999992, 0.127000000000000002, 0.0840000000000000052, 0.076999999999999999, 6),
(3381, 'I', 0.190000000000000002, 0.130000000000000004, 0.0449999999999999983, 0.0264999999999999993, 0.00899999999999999932, 0.0050000000000000001, 0.00899999999999999932, 5),
(3972, 'I', 0.400000000000000022, 0.294999999999999984, 0.0950000000000000011, 0.252000000000000002, 0.110500000000000001, 0.0575000000000000025, 0.0660000000000000031, 6),
(1155, 'M', 0.599999999999999978, 0.455000000000000016, 0.170000000000000012, 1.1915, 0.695999999999999952, 0.239499999999999991, 0.239999999999999991, 8),
(3467, 'M', 0.640000000000000013, 0.5, 0.170000000000000012, 1.4544999999999999, 0.642000000000000015, 0.357499999999999984, 0.353999999999999981, 9),
(2433, 'F', 0.609999999999999987, 0.484999999999999987, 0.165000000000000008, 1.08699999999999997, 0.425499999999999989, 0.232000000000000012, 0.380000000000000004, 11),
(552, 'I', 0.614999999999999991, 0.489999999999999991, 0.154999999999999999, 0.988500000000000045, 0.41449999999999998, 0.195000000000000007, 0.344999999999999973, 13),
(1425, 'F', 0.729999999999999982, 0.57999999999999996, 0.190000000000000002, 1.73750000000000004, 0.678499999999999992, 0.434499999999999997, 0.520000000000000018, 11),
(2402, 'F', 0.584999999999999964, 0.41499999999999998, 0.154999999999999999, 0.69850000000000001, 0.299999999999999989, 0.145999999999999991, 0.195000000000000007, 12),
(1748, 'F', 0.699999999999999956, 0.535000000000000031, 0.174999999999999989, 1.77299999999999991, 0.680499999999999994, 0.479999999999999982, 0.512000000000000011, 15),
(3983, 'I', 0.57999999999999996, 0.434999999999999998, 0.149999999999999994, 0.891499999999999959, 0.362999999999999989, 0.192500000000000004, 0.251500000000000001, 6),
(335, 'F', 0.739999999999999991, 0.599999999999999978, 0.195000000000000007, 1.97399999999999998, 0.597999999999999976, 0.408499999999999974, 0.709999999999999964, 16),
(1587, 'I', 0.515000000000000013, 0.349999999999999978, 0.104999999999999996, 0.474499999999999977, 0.212999999999999995, 0.122999999999999998, 0.127500000000000002, 10),
(2448, 'I', 0.275000000000000022, 0.204999999999999988, 0.0800000000000000017, 0.096000000000000002, 0.0359999999999999973, 0.0184999999999999991, 0.0299999999999999989, 6),
(1362, 'F', 0.604999999999999982, 0.474999999999999978, 0.174999999999999989, 1.07600000000000007, 0.463000000000000023, 0.219500000000000001, 0.33500000000000002, 9),
(2799, 'M', 0.640000000000000013, 0.484999999999999987, 0.149999999999999994, 1.09800000000000009, 0.519499999999999962, 0.222000000000000003, 0.317500000000000004, 10),
(1413, 'F', 0.67000000000000004, 0.505000000000000004, 0.174999999999999989, 1.01449999999999996, 0.4375, 0.271000000000000019, 0.3745, 10),
(1739, 'F', 0.67000000000000004, 0.540000000000000036, 0.195000000000000007, 1.61899999999999999, 0.739999999999999991, 0.330500000000000016, 0.465000000000000024, 11),
(1152, 'M', 0.584999999999999964, 0.465000000000000024, 0.160000000000000003, 0.955500000000000016, 0.45950000000000002, 0.235999999999999988, 0.265000000000000013, 7),
(2427, 'I', 0.564999999999999947, 0.434999999999999998, 0.154999999999999999, 0.782000000000000028, 0.271500000000000019, 0.16800000000000001, 0.284999999999999976, 14),
(1777, 'M', 0.484999999999999987, 0.369999999999999996, 0.154999999999999999, 0.967999999999999972, 0.418999999999999984, 0.245499999999999996, 0.236499999999999988, 9),
(3294, 'M', 0.574999999999999956, 0.455000000000000016, 0.184999999999999998, 1.15599999999999992, 0.552499999999999991, 0.242999999999999994, 0.294999999999999984, 13),
(1403, 'M', 0.650000000000000022, 0.510000000000000009, 0.190000000000000002, 1.54200000000000004, 0.715500000000000025, 0.373499999999999999, 0.375, 9),
(2256, 'M', 0.510000000000000009, 0.395000000000000018, 0.14499999999999999, 0.61850000000000005, 0.215999999999999998, 0.138500000000000012, 0.239999999999999991, 12),
(3984, 'F', 0.584999999999999964, 0.450000000000000011, 0.125, 0.873999999999999999, 0.354499999999999982, 0.20749999999999999, 0.225000000000000006, 6),
(1116, 'M', 0.525000000000000022, 0.405000000000000027, 0.119999999999999996, 0.755499999999999949, 0.3755, 0.155499999999999999, 0.201000000000000012, 9),
(1366, 'M', 0.609999999999999987, 0.474999999999999978, 0.170000000000000012, 1.02649999999999997, 0.434999999999999998, 0.233500000000000013, 0.303499999999999992, 10),
(3759, 'I', 0.525000000000000022, 0.400000000000000022, 0.140000000000000013, 0.605500000000000038, 0.260500000000000009, 0.107999999999999999, 0.209999999999999992, 9);


DROP TABLE IF EXISTS abalone_out, abalone_out_summary;
SELECT glm(
    'abalone',
    'abalone_out',
    'rings',
    'ARRAY[1, length, diameter, height, whole, shucked, viscera, shell]',
    'family=inverse_gaussian, link=sqr_inverse', NULL, 'max_iter=1000, tolerance=1e-16'
);

SELECT
    assert(relative_error(ARRAY[0.0494401575154695266, -0.0002541294210988752, -0.0299466176891337449, -0.2496384071483527811, -0.0147016509724811600, 0.0419206731962985663, 0.0091436053182623947, 0.0280626752216765508], coef) < 1e-4, 'wrong coef'),
    assert(relative_error(ARRAY[0.008103153425094994, 0.035105132237628373, 0.045470770584648580, 0.051254354898839768, 0.012349282411412839, 0.016442357093398172, 0.023664217974195483, 0.024565594663658274], std_err) < 1e-4, 'wrong std_err'),
    assert(relative_error(ARRAY[6.101347823719620145, -0.007239095964050516, -0.658590503395692251, -4.870579439367868524, -1.190486255208993427, 2.549553750607343350, 0.386389498619096106, 1.142356845250392938], t_stats) < 1e-4, 'wrong t_stats'),
    assert(relative_error(ARRAY[1.331421654935946e-07, 9.942517889710958e-01, 5.130644116198815e-01, 1.081293152394273e-05, 2.392617986546806e-01, 1.377394750036622e-02, 7.007847935120710e-01, 2.585384933771852e-01], p_values) < 1e-4, 'wrong p_values'),
    assert(relative_error(0.006349652289479934, dispersion) < 1e-4, 'wrong dispersion')
FROM abalone_out;

------------------------------------------------------------

DROP TABLE IF EXISTS abalone_out, abalone_out_summary;
SELECT glm(
    'abalone',
    'abalone_out',
    'rings',
    'ARRAY[1, length, diameter, height, whole, shucked, viscera, shell]',
    'family=inverse_gaussian, link=identity', NULL, 'max_iter=1000, tolerance=1e-16'
);

SELECT
    assert(relative_error(ARRAY[-0.04277991698963327, 11.28152204761747690, -19.83558055768453343, 98.14918937119004738, 5.59128008750563765, -18.75158172240961463, -8.55285968728226997, 6.77665063275955859], coef) < 1e-4, 'wrong coef'),
    assert(relative_error(ARRAY[0.5446780408533861, 10.8952634819643031, 13.5484546922383107, 17.7005339074502110, 7.7330035915146915, 7.9205407031989115, 11.7032946011067338, 11.5257419241616539], std_err) < 1e-4, 'wrong std_err'),
    assert(relative_error(ARRAY[-0.07854165907369225, 1.03545197105995412, -1.46404745103867939, 5.54498468150041202, 0.72304118591653899, -2.36746232676215040, -0.73080786041850643, 0.58795786660410332], t_stats) < 1e-4, 'wrong t_stats'),
    assert(relative_error(ARRAY[9.376986561177969e-01, 3.052493449659116e-01, 1.492004913454795e-01, 9.969412812417147e-07, 4.728943726806739e-01, 2.166603865536204e-02, 4.681767232791602e-01, 5.591054989961013e-01], p_values) < 1e-4, 'wrong p_values'),
    assert(relative_error(0.00379401089487415, dispersion) < 1e-4, 'wrong dispersion')
FROM abalone_out;

------------------------------------------------------------
-- Grouping support

DROP TABLE IF EXISTS abalone_out, abalone_out_summary;
SELECT glm(
    'abalone',
    'abalone_out',
    'rings',
    'ARRAY[1, length, diameter, height, whole, shucked, viscera, shell]',
    'family=inverse_gaussian, link=log', 'sex', 'max_iter=1000, tolerance=1e-16'
);

SELECT
    assert(relative_error(ARRAY[1.284074483900677,  3.684651998999885, -3.832699198698142,  9.067995169937609,  3.221195216859447, -4.070720439244995, -5.369972663487212, -3.683847003719623], coef) < 1e-4, 'wrong coef'),
    assert(relative_error(ARRAY[0.6952305162768949, 3.3908798070925155, 3.9664727105985800, 3.4145224271158061, 1.4024550773576712, 1.7686015440932459, 1.9049371935738784, 3.0025198835481262], std_err) < 1e-4, 'wrong std_err'),
    assert(relative_error(ARRAY[1.8469765837914662, 1.0866359790438171, -0.9662739361491157, 2.6557140459602144, 2.2968259510517917, -2.3016605706584041, -2.8189762274589927, -1.2269184373781270], t_stats) < 1e-4, 'wrong t_stats'),
    assert(relative_error(ARRAY[0.08954382644250655, 0.29854331671763978, 0.35297804576559544, 0.02095669197510102, 0.04042916336695718, 0.04007691820160381, 0.01548933106941323, 0.24338118632811356], p_values) < 1e-4, 'wrong p_values'),
    assert(relative_error(0.002915138588482358, dispersion) < 1e-4, 'wrong dispersion')
FROM abalone_out where sex = 'M';

------------------------------------------------------------

DROP TABLE IF EXISTS abalone_out, abalone_out_summary;
SELECT glm(
    'abalone',
    'abalone_out',
    'rings',
    'ARRAY[1, length, diameter, height, whole, shucked, viscera, shell]',
    'family=inverse_gaussian, link=inverse', 'sex', 'max_iter=1000, tolerance=1e-16'
);

SELECT
    assert(relative_error(ARRAY[0.1961628019247443, -0.2519461057184665,  0.2669747257125019, -0.9354742821802164, -0.2603230667297666,  0.3386484558794496,  0.4882560733197303,  0.2841967878919081], coef) < 1e-4, 'wrong coef'),
    assert(relative_error(ARRAY[0.06514703367979956, 0.29889555373207449, 0.37108884527976344, 0.32750319463986138, 0.11460434021228023, 0.15442035605105844, 0.17960996148355771, 0.25503381113933749], std_err) < 1e-4, 'wrong std_err'),
    assert(relative_error(ARRAY[3.0110780314095766, -0.8429235650133063, 0.7194361380257333, -2.8563821589859910, -2.2714939612895404, 2.1930298863413897, 2.7184242415442386, 1.1143494528128954], t_stats) < 1e-4, 'wrong t_stats'),
    assert(relative_error(ARRAY[0.01084119008700171, 0.41575665062723632, 0.48564796359850027, 0.01445056184787414, 0.04232366120350028, 0.04874238981153715, 0.01866215566070185, 0.28695082368315938], p_values) < 1e-4, 'wrong p_values'),
    assert(relative_error(0.002713970006368183, dispersion) < 1e-4, 'wrong dispersion')
FROM abalone_out where sex = 'M';
